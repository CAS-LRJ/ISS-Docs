---
layout: default
title: Frenet Optimal Trajectory
parent: Planning
nav_order: 1
---



# frenet_lattice

lqz27, lirj19

frenet_lattice planner is a lattice __local planner__ which is accomplished based on paper [_Optimal Trajectory Generation for Dynamic Street Scenarios in a Fren ÃÅet Frame_](https://fileadmin.cs.lth.se/ai/Proceedings/ICRA2010/MainConference/data/papers/1650.pdf). In frenet_lattice planner, you can just use [LatticePlanner.run_step](https://github.com/CAS-LRJ/ISS/blob/main/ISS/algorithms/planning/local_planner/lattice_planner.py) to get trajectory with inputs, such as current Cartesian state, et al.




## Inputs

The inputs of frenet_lattice planner can come from Carla or physic enviroments, including:

- **map**

   This provide traffic information for frenet_lattice planner. Such as, lane width, traffic light position, et al.
   The most common map is: lanelet, OpenDRIVE, et al.


- **path** generated by global planner. 

   This provide  a reference line.

- **obstacle information**. 

   Including: obstacles' postion, yaw, bounding box, et al.


- **decision** generated by behavior planner

   Including: velocity keeping, Following, Merging, Stopping, et al.





## Outputs

The outputs of frenet_lattice is trajectory which contains position and speed.And it must be dynamically feasible for the vehicle, comfortable for the passenger, and avoid collisions with obstacles detected by the on-board sensors. In conclusion, outputs contains:

- **trajectory**

   Including: Speed, position and its cost.


## FrenetPath <a name="FrenetPath"></a> (_class_)
Store the trajectories(paths) which are generated by frenet_lattice planner. This class not only contain Frenet coordinate `[s, s_d, s_dd, s_ddd, d, d_dd, d_ddd]` and Cartesian coordinate `[x, y, yaw, ds, c]`, but also cost of trajectory.

### Instance Variables
- <a name="FrenetPath.t"></a>**<font color="#f8805a">t</font>** (_list(float <small>- seconds</small>)_)  
   Time of each Frenet point in Frenet path.

- <a name="FrenetPath.s"></a>**<font color="#f8805a">s</font>** (_list(float <small>- meters</small>)_)  
   Frenet longitudinal movement. Also represents the arc length, indicates the distance a vehicle has traveled along the road centerline. The value of s can be used to denote the vehicle's position.

- <a name="FrenetPath.d"></a>**<font color="#f8805a">d</font>** (_list(float <small>- meters</small>)_)  
   Frenet lateral offset. Indicates the lateral distance of the vehicle relative to the road centerline. The value of _d_ can be used to represent the vehicle's lateral position. A positive value indicates the vehicle is on the right side of the road, while a negative value indicates the left side.

- <a name="FrenetPath.s_d"></a>**<font color="#f8805a">s_d</font>** (_list(float <small>- m/s</small>)_)  
   Frenet longitudinal velocity. Indicates the speed of the vehicle in the direction along the road centerline.

- <a name="FrenetPath.d_d"></a>**<font color="#f8805a">d_d</font>** (_list(float <small>- m/s</small>)_)  
   Frenet longitudinal velocity.Represents the derivative of lateral offset _d_ with respect to time. It denotes the rate of change of lateral offset, indicating how rapidly the vehicle is changing its lateral position. 

- <a name="FrenetPath.s_dd"></a>**<font color="#f8805a">s_dd</font>** (_list(float <small>- m/s<sup>2</sup></small>)_)  
   Frenet longitudinal acceleration. Represents the rate of change of longitudinal velocity. It quantifies how quickly the vehicle is speeding up or slowing down along the road.

- <a name="FrenetPath.d_dd"></a>**<font color="#f8805a">d_dd</font>** (_list(float <small>- m/s<sup>2</sup></small>)_)  
   Frenet lateral acceleration.Represents the rate of change of lateral velocity. It quantifies how quickly the lateral speed of the vehicle changes over time.

- <a name="FrenetPath.s_ddd"></a>**<font color="#f8805a">s_ddd</font>** (_list(float <small>- m/s<sup>3</sup></small>)_)  
   Frenet longitudinal jerk. Represents the rate of change of longitudinal acceleration. It is related to driving comfort.

- <a name="FrenetPath.d_ddd"></a>**<font color="#f8805a">d_ddd</font>** (_list(float <small>- m/s<sup>3</sup></small>)_)  
   Frenet lateral jerk.Represents the rate of change of lateral acceleration. It is related to driving comfort.


- <a name="FrenetPath.x"></a>**<font color="#f8805a">x</font>** (_list(float <small>- seconds</small>)_)  
   Cartesian horizontal coordinate x-axis. It measures the horizontal distance of an object relative to a coordinate origin point. 

- <a name="FrenetPath.y"></a>**<font color="#f8805a">y</font>** (_list(float <small>- meters</small>)_)  
   Cartesian vertical coordinate y-axis. It measures the vertical distance of an object relative to a coordinate origin point. 

- <a name="FrenetPath.yaw"></a>**<font color="#f8805a">yaw</font>** (_list(float <small>- radians</small>)_)  
   Cartesian yaw angle. It is the orientation angle of the object.

- <a name="FrenetPath.ds"></a>**<font color="#f8805a">ds</font>** (_list(float <small>- meters</small>)_)  
   Cartesian arc length. It is the distance between two trajectories' points.

- <a name="FrenetPath.c"></a>**<font color="#f8805a">c</font>** (_list(float <small>- 1/radian</small>)_)  
   Cartesian curvature. It describes the degree of curvature of trajectories.

- <a name="FrenetPath.cv"></a>**<font color="#f8805a">cv</font>** (_float_)
   Frenet longitudinal s(velocity) Cost of this trajectory. Initial with zero.

- <a name="FrenetPath.cd"></a>**<font color="#f8805a">cd</font>** (_float_)   
   Frenet lateral d Cost of this trajectory. Initial with zero.

- <a name="FrenetPath.cf"></a>**<font color="#f8805a">cf</font>** (_float_)   
   Final Cost of this trajectory. It is the sum of longitudinal and lateral Cost. Initial with zero.



## LatticePlanner <a name="LatticePlanner"></a> (_class_)
LatticePlanner is a local planner which generate the best trajectory, so called  FrenetPath with inputs, including map, global waypoints, et al. 


### Instance Variables
- <a name="LatticePlanner.route_graph"></a>**<font color="#f8805a">route_graph</font>** (_DataType=Unkown_)   
   A graph that represents the road network based on a lanelet map and traffic rules. In FrenetPlanner, it's used to get left/right lane for lateral planning.

- <a name="LatticePlanner.waypoints_xy"></a>**<font color="#f8805a">waypoints_xy</font>** (_list(list(float,float))_)   
   The list of xy coordinate which is the outputs of global planner which is so called global waypoints.    
   For instance, **<span style="color:#ADD8E6">[[x<sub>0</sub>, y<sub>0</sub>], [x<sub>1</sub>, y<sub>1</sub>], ...]</span>**.

- <a name="LatticePlanner.state_cartesian"></a>**<font color="#f8805a">state_cartesian</font>** (_list_)   
   Current cartesian state, defined as **<span style="color:#ADD8E6"> [x, y, yaw, v, a]</span>**, where x y is xy coordinates, yaw refers to rotation around the vertical axis, v is velocity, a is acceleration. state_cartesian is measured in _<small>[meters, meters, radians, m/s, m/s<sup>2</sup>]</small>_.

- <a name="LatticePlanner.state_frenet"></a>**<font color="#f8805a">state_frenet</font>** (_list_)   
   Current frent state, defined as  **<span style="color:#ADD8E6">[s, s_d, s_dd, d, d_d, d_dd]</span>**. Where, s s_d and s_dd represents Frenet longitudinal coordinate velocity and acceleration, d, d_d and d_dd represents lateral coordinate velocity and acceleration. state_frenet is measured in _<small>[meters, m/s, m/s<sup>2</sup>, meters, m/s, m/s<sup>2</sup>]</small>_.

- <a name="LatticePlanner.best_path"></a>**<font color="#f8805a">best_path</font>** (_FrenetPath_)   
   The best trajectory(path) of FrenetPlanner based on current state_frenet.

- <a name="LatticePlanner.road_detector"></a>**<font color="#f8805a">road_detector</font>** (_Sensor_)   
   Detect road. Return road line position.

- <a name="LatticePlanner.obstacle_detector"></a>**<font color="#f8805a">obstacle_detector</font>** (_Sensor_)   
   Detect obstacle. Return <b> True </b> when obstacle is nearby the trajectory.




### Methods
- <a name="LatticePlanner._generate_target_course"></a>**<font color="#7fb800">_generate_target_course</font>**(<font color="#00a6ed">**self**</font>)  
Generates smooth reference line based on global waypoints by using **<span style="color:#ADD8E6">cubic spline</span>**. 
  - **Return:** _[rx](#FrenetPath.x)_, _[ry](#FrenetPath.y)_, _[ryaw](#FrenetPath.yaw)_, _[rk](#FrenetPath.c)_, _[csp](#Spline2D)_

- <a name="LatticePlanner._calc_frenet_paths"></a>**<font color="#7fb800">_calc_frenet_paths</font>**(<font color="#00a6ed">**self**</font>)  
Generates all **frenet paths** which just contain Frenet coordinate and cost but not Cartesian coordinate by sampling time _`Ti`_,  lateral d _`lat_qp`_ and longitudinal s _`lon_qp`_.
  - **Return:** _[frenet_paths](#FrenetPath)_ (_list(FrenetPath)_)

- <a name="LatticePlanner._calc_global_paths"></a>**<font color="#7fb800">_calc_frenet_paths</font>**(<font color="#00a6ed">**self**</font>, <font color="#00a6ed">**fplist**</font>)  
Gets Cartesian coordinate of frenet_paths.
  - **Parameters:**
    - `fplist` (_list(FrenetPath)_) - **frenet paths** which just contain Frenet coordinate and cost but not Cartesian coordinate.  
  - **Return:** _[filtered_fplist](#FrenetPath)_ (_list(FrenetPath)_) - which contain Cartesian coordinate, Frenet coordinate and cost.

- <a name="LatticePlanner._check_paths"></a>**<font color="#7fb800">_check_paths</font>**(<font color="#00a6ed">**self**</font>, <font color="#00a6ed">**fplist**</font>)  
Gets comfortable, kinematically feasible trajectories.
  - **Parameters:**
    - `fplist` (_list(FrenetPath)_) - **frenet paths** which contain Cartesian coordinate, Frenet coordinate and cost.
  - **Return:** _[fplist](#FrenetPath)_(_list(FrenetPath)_) - which is comfortable and kinematically feasible.

- <a name="LatticePlanner.frenet_optimal_planning"></a>**<font color="#7fb800">frenet_optimal_planning</font>**(<font color="#00a6ed">**self**</font>)  
Gets best trajectory. First generates all trajectories which is not containing Cartesian coordinate by using methods <span style="color:#ADD8E6">LatticePlanner._generate_target_course</span>. Then gets Cartesian coordinate trajectories by using method <span style="color:#ADD8E6">LatticePlanner._calc_frenet_paths</span> and filters not kinematically feasible trajectories by using <span style="color:#ADD8E6">LatticePlanner._check_paths</span>. Finally, gets best trajectory by minimizing the cost.
  - **Return:** _[best_path](#FrenetPath)_(_FrenetPath_) - Trajectory with minimum cost.

- <a name="LatticePlanner.run_step"></a>**<font color="#7fb800">run_step</font>**(<font color="#00a6ed">**self**</font>, <font color="#00a6ed">**state_cartesian**</font>)  
Main method of LatticePlanner which calls method frenet_optimal_planning to get a best trajectory.
  - **Parameters:**
    - `state_cartesian` (_[x, y, yaw, ds, c]_) - Currenet Cartesian coordinate of ego vehicle.
   - **Return:** _[Trajectory(waypoints, speeds)](#Trajectory)(_Trajectory_)_ - which is the list of waypoint _`[x,y]`_ and speed.